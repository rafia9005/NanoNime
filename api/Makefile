.PHONY: run dev stop clean help install build check setup

# Colors
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

.DEFAULT_GOAL := help

## help: Display this help message
help:
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo "$(BLUE)โ              Nanonime API - Makefile Commands                  โ$(NC)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo ""
	@echo "$(GREEN)Available commands:$(NC)"
	@echo ""
	@echo "  make run         - Run both Air (Go) and npm (Anime API) with hot reload"
	@echo "  make dev         - Alias for run"
	@echo "  make air         - Run only Air (Go API)"
	@echo "  make npm         - Run only npm (Anime API)"
	@echo "  make stop        - Stop all running processes"
	@echo "  make install     - Install all dependencies"
	@echo "  make build       - Build both projects"
	@echo "  make clean       - Clean build artifacts"
	@echo "  make check       - Check dependencies"
	@echo "  make setup       - Initial setup"
	@echo ""

## run: Run both Air and npm with hot reload
run:
	@./run-dev.sh

## dev: Alias for run
dev: run

## air: Run only Air (Go API)
air:
	@echo "$(GREEN)๐ Starting Go API with Air...$(NC)"
	@air

## npm: Run only npm (Anime API)
npm:
	@echo "$(BLUE)๐ Starting Anime API with npm...$(NC)"
	@cd endpoint/anime && npm run dev

## install: Install dependencies
install:
	@echo "$(GREEN)๐ฆ Installing Go dependencies...$(NC)"
	@go mod download
	@echo ""
	@echo "$(BLUE)๐ฆ Installing npm dependencies...$(NC)"
	@cd endpoint/anime && npm install
	@echo ""
	@echo "$(GREEN)โ All dependencies installed!$(NC)"

## build: Build both projects
build:
	@echo "$(GREEN)๐จ Building Go API...$(NC)"
	@go build -o ./tmp/main .
	@echo ""
	@echo "$(BLUE)๐จ Building Anime API...$(NC)"
	@cd endpoint/anime && npm run build
	@echo ""
	@echo "$(GREEN)โ Build complete!$(NC)"

## clean: Clean build artifacts
clean:
	@echo "$(YELLOW)๐งน Cleaning build artifacts...$(NC)"
	@rm -rf tmp/
	@rm -rf endpoint/anime/dist/
	@rm -f build-errors.log
	@echo "$(GREEN)โ Clean complete!$(NC)"

## stop: Stop all running processes
stop:
	@echo "$(RED)๐ Stopping all processes...$(NC)"
	@pkill -9 -f "^air$$" 2>/dev/null || true
	@pkill -9 -f "tsx watch" 2>/dev/null || true
	@pkill -9 -f "npm run dev" 2>/dev/null || true
	@lsof -ti:8080 2>/dev/null | xargs kill -9 2>/dev/null || true
	@lsof -ti:3001 2>/dev/null | xargs kill -9 2>/dev/null || true
	@echo "$(GREEN)โ All processes stopped!$(NC)"

## check: Check dependencies
check:
	@echo "$(BLUE)๐ Checking dependencies...$(NC)"
	@echo ""
	@command -v go >/dev/null 2>&1 && echo "$(GREEN)โ Go installed$(NC)" || echo "$(RED)โ Go not installed$(NC)"
	@command -v air >/dev/null 2>&1 && echo "$(GREEN)โ Air installed$(NC)" || echo "$(YELLOW)โ๏ธ  Air not installed$(NC)"
	@command -v node >/dev/null 2>&1 && echo "$(GREEN)โ Node.js installed$(NC)" || echo "$(RED)โ Node.js not installed$(NC)"
	@command -v npm >/dev/null 2>&1 && echo "$(GREEN)โ npm installed$(NC)" || echo "$(RED)โ npm not installed$(NC)"
	@[ -f config.toml ] && echo "$(GREEN)โ config.toml exists$(NC)" || echo "$(YELLOW)โ๏ธ  config.toml not found$(NC)"
	@[ -d endpoint/anime/node_modules ] && echo "$(GREEN)โ npm dependencies installed$(NC)" || echo "$(YELLOW)โ๏ธ  npm dependencies not installed$(NC)"
	@echo ""

## setup: Initial setup
setup:
	@echo "$(BLUE)๐ง Setting up Nanonime API...$(NC)"
	@echo ""
	@if [ ! -f config.toml ]; then \
		echo "$(YELLOW)๐ Creating config.toml...$(NC)"; \
		cp config-example.toml config.toml; \
		echo "$(GREEN)โ config.toml created!$(NC)"; \
		echo ""; \
	fi
	@$(MAKE) install
	@echo ""
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo "$(GREEN)โ                  โ Setup Complete!                            โ$(NC)"
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo ""
	@echo "$(YELLOW)Next steps:$(NC)"
	@echo "  1. Update config.toml with your settings"
	@echo "  2. Run: $(GREEN)make run$(NC)"
	@echo ""
